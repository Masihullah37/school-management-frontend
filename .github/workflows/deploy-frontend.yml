# ============================================================================
# Workflow: Construction et D√©ploiement du Frontend React
# Description: Compile l'application React avec Vite et d√©ploie sur Hostinger
# D√©clencheur: Push sur la branche main
# ============================================================================
name: Build and Deploy Frontend

on:
  push:
    branches: [ main ]        # D√©clench√© automatiquement lors du push sur main
  workflow_dispatch:          # Permet √©galement le d√©clenchement manuel

# ============================================================================
# JOBS: Deux √©tapes distinctes - Build puis Deploy
# ============================================================================
jobs:
  
  # ==========================================================================
  # √âTAPE 1: BUILD - Construction de l'application React
  # Objectif: Compiler le code source React en fichiers statiques optimis√©s
  # ==========================================================================
  build:
    name: üî® Construction du Frontend
    runs-on: ubuntu-latest    # Utilise une machine virtuelle Ubuntu
    
    steps:
    # ------------------------------------------------------------------------
    # R√©cup√©ration du code source depuis le d√©p√¥t GitHub
    # ------------------------------------------------------------------------
    - name: üì• R√©cup√©ration du code source
      uses: actions/checkout@v3
    
    # ------------------------------------------------------------------------
    # Installation de Node.js 18 (version LTS)
    # N√©cessaire pour ex√©cuter npm et compiler React avec Vite
    # ------------------------------------------------------------------------
    - name: ‚öôÔ∏è Configuration de Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: '18'    # Version Long Term Support
        cache: 'npm'          # Active la mise en cache des d√©pendances npm
    
    # ------------------------------------------------------------------------
    # Installation des d√©pendances npm du projet
    # npm ci: Installation propre bas√©e sur package-lock.json (plus fiable)
    # ------------------------------------------------------------------------
    - name: üì¶ Installation des d√©pendances
      run: npm ci
    
    # ------------------------------------------------------------------------
    # Cr√©ation du fichier de configuration pour la production
    # D√©finit l'URL de l'API backend pour l'environnement de production
    # ------------------------------------------------------------------------
    - name: üìù Cr√©ation du fichier .env de production
      run: |
        echo "VITE_API_URL=https://schoolproject.fr/api" > .env.production
    
    # ------------------------------------------------------------------------
    # Compilation de l'application React avec Vite
    # G√©n√®re les fichiers statiques optimis√©s dans le dossier dist/
    # Minification, tree-shaking, et optimisation des assets
    # ------------------------------------------------------------------------
    - name: üèóÔ∏è Compilation de l'application pour production
      run: npm run build
    
    # ------------------------------------------------------------------------
    # Sauvegarde des fichiers compil√©s comme artefact
    # Permet de transf√©rer le build entre les jobs (build ‚Üí deploy)
    # Conserv√© pendant 1 jour (suffisant pour le d√©ploiement)
    # ------------------------------------------------------------------------
    - name: üì§ Sauvegarde de l'artefact de build
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build   # Nom de l'artefact
        path: dist/            # Dossier contenant les fichiers compil√©s
        retention-days: 1      # Dur√©e de conservation (1 jour)

  # ==========================================================================
  # √âTAPE 2: DEPLOY - D√©ploiement sur le serveur Hostinger
  # Objectif: Transf√©rer les fichiers compil√©s vers le serveur web
  # ==========================================================================
  deploy:
    name: üöÄ D√©ploiement sur Hostinger
    runs-on: ubuntu-latest
    needs: build              # Attend la fin du job "build" avant de commencer
    
    
    steps:
    # ------------------------------------------------------------------------
    # R√©cup√©ration de l'artefact cr√©√© lors de l'√©tape de build
    # ------------------------------------------------------------------------
    - name: üì• T√©l√©chargement de l'artefact de build
      uses: actions/download-artifact@v3
      with:
        name: frontend-build   # Nom de l'artefact √† t√©l√©charger
    
    # ------------------------------------------------------------------------
    # Transfert des fichiers vers Hostinger via SCP (Secure Copy Protocol)
    # Utilise les secrets GitHub pour l'authentification SSH s√©curis√©e
    # strip_components: 1 retire le dossier parent (dist/) lors de la copie
    # ------------------------------------------------------------------------
    - name: üì§ Transfert des fichiers vers Hostinger
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOSTINGER_SSH_HOST }}        # Adresse IP du serveur
        username: ${{ secrets.HOSTINGER_SSH_USER }}    # Nom d'utilisateur SSH
        key: ${{ secrets.HOSTINGER_SSH_KEY }}          # Cl√© priv√©e SSH
        port: ${{ secrets.HOSTINGER_SSH_PORT }}        # Port SSH (65002)
        source: "*"                                    # Tous les fichiers du dossier dist/
        target: "/home/${{ secrets.HOSTINGER_SSH_USER }}/domains/schoolproject.fr/public_html/"
        strip_components: 0                            # Ne pas retirer de niveau de dossier
    
    # ------------------------------------------------------------------------
    # Notification de succ√®s du d√©ploiement
    # ------------------------------------------------------------------------
    - name: ‚úÖ D√©ploiement termin√© avec succ√®s
      run: |
        echo "üéâ Frontend d√©ploy√© avec succ√®s sur https://schoolproject.fr"
        echo "üìä Statistiques du build:"
        echo "  - Plateforme: Hostinger"
        echo "  - Domaine: schoolproject.fr"
        echo "  - Date: $(date)"